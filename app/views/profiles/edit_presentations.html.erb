<div class="manage-profile-list">
  <div class="row">
    <div class='col-11'>
      <h4>Manage Profile Presentations</h4>
    </div>
    <div class='col-1'>
      <button id="select-all" class="btn btn-secondary btn-sm mb-2">Select All</button>
    </div>
  </div>
  <table class="table">
    <thead>
    <tr>
      <th></th>
      <th>Presentation</th>
      <th>Visible in profile</th>
    </tr>
    </thead>
    <tbody id="presentation-contributions">
      <% @presentation_contributions.each do |c| %>
        <tr id="<%= dom_id(c) %>">
          <td><%= fa_icon 'arrows-v' %></td>
          <td class="pres-title"><%= "#{c.presentation_label} - #{c.presentation_organization} - #{c.presentation_location}" %></td>
          <td class="visibility">
            <%= form_with model: c, method: :put, class: 'visibility-control', remote: true do |f| %>
              <%= f.check_box :visible_in_profile, class: 'visibility-toggle', id: dom_id(c) %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAllBtn = document.getElementById("select-all");
  const checkboxes = () => Array.from(document.querySelectorAll(".visibility-toggle"));

  function updateButtonLabel() {
    const cbs = checkboxes();
    const allChecked = cbs.length > 0 && cbs.every(cb => cb.checked);
    selectAllBtn.textContent = allChecked ? "Deselect All" : "Select All";
  }

  selectAllBtn.addEventListener("click", async function () {
    const cbs = checkboxes();
    const allChecked = cbs.every(cb => cb.checked);
    const newState = !allChecked;

    cbs.forEach(cb => cb.checked = newState);

    fetch("/presentation_contributions/bulk_update_visibility", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ visible_in_profile: newState })
    })
    updateButtonLabel();
  });

  document.addEventListener("change", function (e) {
    if (e.target.matches(".visibility-toggle")) {
      updateButtonLabel();
    }
  });
  updateButtonLabel();
});
</script>
